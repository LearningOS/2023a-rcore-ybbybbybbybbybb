# 简答作业

# 1. SV39 页表项的组成与作用

- **0--7 : 标志位，8--9 : 保留位(RSW)，10--53 : 物理页号(PageTableNumber)，54--63 : 保留位(RSW)**

- **标志位作用**
    - **0 :** `V-Vilid` 位，有效标志位， 如果为 1，表示此页表项有效。如果为 0，则该页表项不指向有效的物理页，并且不能用于地址转换。
    - **1 :** `R-Readable` 位，读标志位，如果为 1，表示此页表项可读，如果为 0，表示此页表项不可读，如果 `RWX` 三位都为零表示该个页表项是指向下一级页表的指针，否则它是页表树的一个叶节点。
    - **2 :** `W-Writable` 位，写标志位，如果为 1，表示此页表项可写，如果为 0，表示此页表项不可写，如果 `RWX` 三位都为零表示该个页表项是指向下一级页表的指针，否则它是页表树的一个叶节点。
    - **3 :** `X-Executable` 位，执行标志位，如果为 1，表示此页表项可执行，如果为 0，表示此页表项不可执行，如果 `RWX` 三位都为零表示该个页表项是指向下一级页表的指针，否则它是页表树的一个叶节点。
    - **4 :** `U-User` 位，用户标志位，如果为 1，表示在 `U` 模式下可以访问该页面。如果为 0，则只有在 `S` 模式下才能访问。
    - **5 :** `G-Global` 位，全局标志位，如果为 1，表示这个映射对所有虚址空间有效，硬件可以用这个信息来提高地址转换的性能。这一位通常只用于属于操作系统的页面。
    - **6 :** `A-Accessed` 位，用户访问标志位，如果为 1，该页表项自上次 A 位置 0 后被访问过。
    - **7 :** `D-Dirty` 位，脏标志位，如果为 1，表示此页表项被写入过。如果为 0，则该页表项未被写入过。

# 2.缺页
- **可能由缺页导致的异常 :**
    - `Instruction access fault`
    - `Load access fault`
    - `Store access fault`
    - `Instruction page fault`
    - `Load page fault`
    - `Store page fault`

- **重要寄存器的值 :**
    - sepc: 导致页错误的指令的地址。
    - stval: 导致页错误的虚拟地址。
    - scause: 描述异常原因。
    - stvec: 发生异常时处理器需要跳转到的地址。
    - sstatus: `SIE` 置 `0` 屏蔽中断。

- **好处 :**
    - 节省内存：只有真正访问的页面才被加载到内存。
    - 快速启动：进程启动时无需预先加载所有页面。
    - 节省 I/O：减少了不必要的磁盘读写操作。

- **占用内存 :**
    - 因为空间连续，只约 `10` 个二级页表节点与 `5120` 个三级页表节点，约 `20MB` 空间

- **实现Lazy与处理缺页 :**
    - 在 `mmap` 申请内存空间时，在判断成功的申请的基础上，只先建立一个 `map_area` 然后直接放入 `memory_set` 中，而不是将这个 `map_area` 进行 `map` 在 `pagetable` 中建立映射操作。
    - 当进程访问无效地址时，会触发页错误。在这种情况下，内核可以检查该地址是否真的不存在 `memory_set` 中或只是尚未建立页表映射。如果是尚未建立页表映射，内核可以从调用 `map_area.map_one` 该地址的获取物理页帧并在 `pagetable` 中建立映射。

- **如何表现 :**
    - 当页面被换出到磁盘时，其对应的 `PTE` 中的 `Valid` 位会被清除，标记该页面失效。

# 3.双页表与单页表
- **更换页表 :**
    - 更改 `sapt` 寄存器的值。

- **拒绝访问 :**
    - 将页表项中的 `User` 位设置为 0。

- **优势 :**
    - 切换页表次数少，刷新 `TLB` 次数更少，使性能较双页表更好。
    - 无需 `trampoline`

- **何时更换页表 :**
    - 在双页表实现下，每次从用户模式切换到内核模式或从内核模式切换到用户模式时都需要更换页表。
    - 切换时机:
        - 上下文切换
        - 创建或销毁进程


# 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：
    - 叶可禾 
    - 范天奇

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：
    - _RISC-V-Reader-Chinese-v2p1_
    - _rCore-Tutorial-Book 第三版_

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。